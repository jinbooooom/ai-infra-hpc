### 推理的两个阶段

大模型推理阶段分为两个过程，prefill和decode。prefill是用户输入完prompt到生成首个token的过程，decode则为生成首个token到推理停止的过程。

在prefill阶段，大模型一次性对prompt中所有token进行计算QKV，由于不同token的计算是独立的，因此该过程可以并行。在attention部分，由计算得到的QKV进一步计算出Output矩阵，再经过后续的FFN层和解码得到首字母token。

在decode阶段，计算原理和prefill完全相同，但计算方式和decode是不能一样的。原因有两个。一是随着seqlen增加，Attention计算复杂度平方级增长，直接计算代价很大，导致长序列的推理时间极慢，甚至不可行。二是对decode阶段的计算过程简单分析发现，该过程可以复用prefill阶段的KV结果，也可以复用docode阶段已经产生的KV结果。综上，可以把已产生的KV存起来，不必重新计算，这就是KV cache。对于Q矩阵，每次需要计算的只是Q的最后一行q，计算关于qKV的attention，而不是关于QKV的attention，这样复杂度降低了一个量级，实现以存换算。

Prefill阶段有几个重要特点：
**整体处理**：模型会一次性处理整个输入问题

**并行计算**：可以同时处理问题中的所有词

**资源密集**：处理长问题时需要大量计算资源

**耗时与问题长度相关**：问题越长，处理时间越长

想象一位速读专家能够快速浏览整篇文章，Prefill阶段就是模型的"速读"过程。

Decode阶段的主要特点包括：

**逐词生成**：模型一次只生成一个词

**顺序执行**：每个新词依赖于之前生成的所有词

**记忆依赖**：需要记住之前的所有内容才能决定下一个词

**耗时与回答长度相关**：回答越长，总生成时间越长

这就像一位作家在写小说，每写一个词都需要考虑已经写过的内容，确保故事连贯和有意义。

**参考**：

[理解大型语言模型的工作机制：Prefill与Decode阶段详解](https://zhuanlan.zhihu.com/p/30218390556)